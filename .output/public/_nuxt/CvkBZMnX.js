import{r as m,C as $}from"./BRfyLXrA.js";import{u as E}from"./BO7EsgoH.js";function S(b={}){const{API_URL:v}=E(),{thumbnailScale:D=.5,enableDflip:y=!0,cdnBaseUrl:f="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174",storageBaseUrl:d=v+"/storage",filters:P={type:"document"}}=b,c=m([]),h=m(!1),w=m(null),p=$(),L=async()=>{if(window.pdfjsLib)return window.pdfjsLib;try{return await Promise.all([new Promise(n=>{const t=document.createElement("script");t.src=`${f}/pdf.min.js`,t.onload=n,document.head.appendChild(t)}),new Promise(n=>{const t=document.createElement("script");t.src=`${f}/pdf.worker.min.js`,t.onload=n,document.head.appendChild(t)})]),await new Promise(n=>setTimeout(n,100)),window.pdfjsLib}catch(n){throw console.error("Failed to load PDF.js",n),n}},g=async(n,t=D)=>{try{const r=await L(),i=`${d}/${n}`,u=await(await r.getDocument(i).promise).getPage(1),o=document.createElement("canvas"),l=u.getViewport({scale:t}),a=o.getContext("2d");return o.width=l.width,o.height=l.height,await u.render({canvasContext:a,viewport:l}).promise,o.toDataURL("image/jpeg",.8)}catch(r){return console.error("Error generating thumbnail:",r),null}},j=async n=>{h.value=!0;try{const r=(await n()).map(async e=>{e.slug=e.slug||e.name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"");let s=0,u=0,o=1,l="unknown";try{if(!e.thumbnail_path&&e.publication_file.toLowerCase().endsWith(".pdf")){const a=await g(e.publication_file);e.thumb=a||void 0}else e.thumbnail_path&&(e.thumb=`${d}/${e.thumbnail_path}`);if(e.thumb){const a=_(e.thumb);a&&(u=a.width||1,s=a.height||1,o=u===0?1/0:s/u,o>1?l="portrait":o<1?l="landscape":l="square")}}catch(a){console.error(`Error processing thumbnail for ${e.name}:`,a)}return{...e,height:s,width:u,heightWidthRatio:parseFloat(o.toFixed(2)),orientation:l}}),i=await Promise.all(r);return c.value=i.sort((e,s)=>s.heightWidthRatio-e.heightWidthRatio),console.log("Processed documents:",c.value.map(e=>({name:e.name,height:e.height,width:e.width,heightWidthRatio:e.heightWidthRatio.toFixed(2),orientation:e.orientation}))),h.value=!1,c.value}catch(t){return h.value=!1,w.value=t instanceof Error?t:new Error(String(t)),console.error(t),[]}},F=(n=c.value)=>{var t;if(!y||!n.length)return!1;if(n.forEach(r=>{r.publication_file.toLowerCase().endsWith(".pdf")&&(window[`df_option_${r.id}`]={source:`${d}/${r.publication_file}`,outline:[],autoEnableOutline:!1,autoEnableThumbnail:!1,overwritePDFOutline:!1,pageSize:"0",is3D:!0,height:"100",direction:"1",slug:r.slug,wpOptions:"true",id:r.id})}),(t=window.DFLIP)!=null&&t.parseBooks){if(window.DFLIP.parseBooks(),p.currentRoute.value.hash){if(p.currentRoute.value.hash==="#_"){p.replace({hash:""});return}const r=n.find(i=>p.currentRoute.value.hash.includes(i.slug));r&&document.getElementById(`df_${r.id}`).click()}return!0}return console.warn("DFLIP library not loaded"),!1},R=(n,t)=>{var e;const r=document.querySelector(".df-lightbox-wrapper"),i=r&&r.style.display!=="none";return window.DFLIP&&i?((e=document.querySelector(".df-lightbox-close"))==null||e.click(),!1):!0},x=(n="")=>c.value.filter(t=>{const r=Object.entries(P).every(([e,s])=>t[e]===s),i=!n||Object.values(t).some(e=>String(e).toLowerCase().includes(n.toLowerCase()));return r&&i}),_=n=>{const t=n.split("-").pop().split(".jpg")[0].split("x");if(t.length===2){const r=parseFloat(t[0],10),i=parseFloat(t[1],10);if(!isNaN(r)&&!isNaN(i))return{width:r,height:i}}return null};return{documents:c,loading:h,error:w,processDocuments:j,initializeDflip:F,generateThumbnail:g,handleRouteLeave:R,filterDocuments:x}}export{S as u};
