import{r as f,H as E}from"./ChtoClap.js";import{u as R}from"./D-80TVpf.js";function S(b={}){const{API_URL:v}=R(),{thumbnailScale:D=.5,enableDflip:y=!0,cdnBaseUrl:m="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174",storageBaseUrl:d=v+"/storage",filters:L={type:"document"}}=b,c=f([]),h=f(!1),w=f(null),p=E(),P=async()=>{if(window.pdfjsLib)return window.pdfjsLib;try{return await Promise.all([new Promise(n=>{const e=document.createElement("script");e.src=`${m}/pdf.min.js`,e.onload=n,document.head.appendChild(e)}),new Promise(n=>{const e=document.createElement("script");e.src=`${m}/pdf.worker.min.js`,e.onload=n,document.head.appendChild(e)})]),await new Promise(n=>setTimeout(n,100)),window.pdfjsLib}catch(n){throw console.error("Failed to load PDF.js",n),n}},g=async(n,e=D)=>{try{const r=await P(),a=`${d}/${n}`,u=await(await r.getDocument(a).promise).getPage(1),i=document.createElement("canvas"),l=u.getViewport({scale:e}),o=i.getContext("2d");return i.width=l.width,i.height=l.height,await u.render({canvasContext:o,viewport:l}).promise,i.toDataURL("image/jpeg",.8)}catch(r){return console.error("Error generating thumbnail:",r),null}},j=async n=>{h.value=!0;try{const r=(await n()).map(async t=>{t.slug=t.slug||t.name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"");let s=0,u=0,i=1,l="unknown";try{if(!t.thumbnail_path&&t.publication_file.toLowerCase().endsWith(".pdf")){const o=await g(t.publication_file);t.thumb=o||void 0}else t.thumbnail_path&&(t.thumb=`${d}/${t.thumbnail_path}`);if(t.thumb){const o=x(t.thumb);o&&(u=o.width||1,s=o.height||1,i=u===0?1/0:s/u,i>1?l="portrait":i<1?l="landscape":l="square")}}catch(o){console.error(`Error processing thumbnail for ${t.name}:`,o)}return{...t,height:s,width:u,heightWidthRatio:parseFloat(i.toFixed(2)),orientation:l}}),a=await Promise.all(r);return c.value=a.sort((t,s)=>s.heightWidthRatio-t.heightWidthRatio),h.value=!1,c.value}catch(e){return h.value=!1,w.value=e instanceof Error?e:new Error(String(e)),console.error(e),[]}},F=(n=c.value)=>{var e;if(!y||!n.length)return!1;if(n.forEach(r=>{r.publication_file.toLowerCase().endsWith(".pdf")&&(window[`df_option_${r.id}`]={source:`${d}/${r.publication_file}`,outline:[],autoEnableOutline:!1,autoEnableThumbnail:!1,overwritePDFOutline:!1,pageSize:"0",is3D:!0,height:"100",direction:"1",slug:r.slug,wpOptions:"true",id:r.id})}),(e=window.DFLIP)!=null&&e.parseBooks){if(window.DFLIP.parseBooks(),p.currentRoute.value.hash){if(p.currentRoute.value.hash==="#_"){p.replace({hash:""});return}const r=n.find(a=>p.currentRoute.value.hash.includes(a.slug));r&&document.getElementById(`df_${r.id}`).click()}return!0}return console.warn("DFLIP library not loaded"),!1},_=(n,e)=>{var t;const r=document.querySelector(".df-lightbox-wrapper"),a=r&&r.style.display!=="none";return window.DFLIP&&a?((t=document.querySelector(".df-lightbox-close"))==null||t.click(),!1):!0},$=(n="")=>c.value.filter(e=>{const r=Object.entries(L).every(([t,s])=>e[t]===s),a=!n||Object.values(e).some(t=>String(t).toLowerCase().includes(n.toLowerCase()));return r&&a}),x=n=>{const e=n.split("-").pop().split(".jpg")[0].split("x");if(e.length===2){const r=parseFloat(e[0],10),a=parseFloat(e[1],10);if(!isNaN(r)&&!isNaN(a))return{width:r,height:a}}return null};return{documents:c,loading:h,error:w,processDocuments:j,initializeDflip:F,generateThumbnail:g,handleRouteLeave:_,filterDocuments:$}}export{S as u};
